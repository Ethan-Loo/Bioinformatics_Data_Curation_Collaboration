RUN=poetry run

# todo more options:
#   linkml-ws setup
#   cogs


.PHONY: all clean sheets/curated sheets/AsnicarF_2021_MAM validate_linkml
clean:
	rm -rf curatedMetagenomicDataCuration/curated_schema.py
	rm -rf data/aggregated.*
	rm -rf data/inst_supplements.txt
	rm -rf schema/autogenerated_schema.yaml
	rm -rf schema/curated_schema_generated.yaml
	rm -rf sheets/AsnicarF_2021_MAM
	rm -rf sheets/curated

all: clean data/inst_supplements.txt data/aggregated.tsv schema/autogenerated_schema.yaml \
schema/curated_schema_generated.yaml curatedMetagenomicDataCuration/curated_schema.py \
sheets/curated schema/curated_roundtrip.yaml data/aggregated.json validate_linkml data/aggregated.db

data/aggregated.tsv: inst/curated/
	$(RUN) python curatedMetagenomicDataCuration/aggregate_data.py \
		--tsv_in_path $< \
		--tsv_out_file $@

schema/autogenerated_schema.yaml: data/aggregated.tsv
	$(RUN) schemauto generalize-tsv $< > $@


sheets/curated: schema/curated_schema.yaml
	# todo move this code into curatedMetagenomicDataCuration
	# todo feed any improvements here back into linkml-abuse or schemasheets
	# class_definition
	# File "/home/mark/gitrepos/curatedMetagenomicDataCuration/utils/verbatim_sheets.py", line 153, in cli
    #    get_classes(schema_view, meta_view, directory)
    # todo KeyError: 'unit'
	$(RUN) python utils/verbatim_sheets.py \
		--schema_source $< \
		--directory $@

sheets/AsnicarF_2021_MAM: schema/AsnicarF_2021_MAM.yaml
	$(RUN) python utils/verbatim_sheets.py \
		--schema_source $< \
		--directory $@


schema/curated_roundtrip.yaml: sheets/curated
	# need to add internal separator rows for notes and todos (don't have any comments yet)
	# internal_separator: "|"
	# delete from schema rows
	# delete usage
	# delete name except for schema?
	$(RUN) sheets2linkml \
		--output $@ sheets/curated/*

schema/AsnicarF_2021_MAM_roundtrip.yaml: sheets/AsnicarF_2021_MAM
	$(RUN) sheets2linkml \
		--output $@ sheets/AsnicarF_2021_MAM/*

#data/aggregated.json: data/aggregated.tsv
#	$(RUN) linkml-convert \
#		--output $@ \
#		--target-class Study \
#		--index-slot samples \
#		--schema schema/curated_schema.yaml $<

schema/curated_schema_generated.yaml: schema/curated_schema.yaml
	$(RUN) gen-linkml \
		--output $@ \
		--format yaml $<

curatedMetagenomicDataCuration/curated_schema.py: schema/curated_schema.yaml
	$(RUN) gen-project \
		--dir curatedMetagenomicDataCuration \
		--include python \
		--include jsonschema $<

data/aggregated.json: data/aggregated.tsv
	$(RUN) python curatedMetagenomicDataCuration/aggregated_to_json.py \
		--verbosity INFO \
		--tsv_in_file $< \
		--schema_file schema/curated_schema.yaml \
		--json_out_file $@ \
		--project_name curatedMetagenomicDataCuration

validate_linkml: data/aggregated.json schema/curated_schema.yaml
	#  --module
	# --index-slot XXX \
	$(RUN) linkml-validate \
		--target-class Project \
		--schema schema/curated_schema.yaml data/aggregated.json

# Failed validating 'pattern' in schema['properties']['studies']['items']['properties']['samples']['items']['properties']['population']:
  #    {'description': 'can describe the belonging to a specific population',
  #     'pattern': '[a-zA-Z]\\\\S+',
  #     'type': 'string'}
  #
  #On instance['studies'][9]['samples'][4]['population']:
  #    'hispanic'

# Failed validating 'pattern' in schema['properties']['studies']['items']['properties']['samples']['items']['properties']['subcohort']:
  #    {'description': 'Identifier of a sub-set of the cohort. Can be '
  #                    'everything.',
  #     'pattern': '[0-9a-zA-Z]\\\\S+',
  #     'type': 'string'}
  #
  #On instance['studies'][37]['samples'][0]['subcohort']:
  #    'Barcelona'


data/aggregated.db: data/aggregated.json schema/curated_schema.yaml
	$(RUN) linkml-sqldb \
		--verbose \
		dump \
		--db $@ \
		--target-class Project \
		--schema schema/curated_schema.yaml data/aggregated.json

# sqlite3.OperationalError: duplicate column name: alt
# todo commented out from schema, so is never reached in XXX.py
# but I wanted to consolidate with ALT!

# todo sqldb conversion failing on enums again https://github.com/linkml/linkml/issues/814

# todo sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: Sample_NCBI_accession.Sample_id, Sample_NCBI_accession.NCBI_accession
  #[SQL: INSERT INTO "Sample_NCBI_accession" ("Sample_id", "NCBI_accession") VALUES (?, ?)]
  #[parameters: ((1, 'SRR4052021'), (2, 'SRR4052022'), (3, 'SRR4052033'), (4, 'SRR4052038'), (5, 'SRR4052039'), (6, 'SRR4052040'), (7, 'SRR4052041'), (8, 'SRR4052042')  ... displaying 10 of 31957 total bound parameter sets ...  (20715, 'ERR2855869'), (20716, 'ERR2855830'))]
  #(Background on this error at: https://sqlalche.me/e/14/gkpj)

# ensured that split multivalued values are unique. seems to solve UNIQUE constraint failed above
# note these primary key assumptions:
# INFO:root:Added primary key Sample.id
  #INFO:root:Added primary key Study.id
  #INFO:root:Added primary key Project.id

data/inst_supplements.txt:
	 ls -1R inst/ | grep '\.' | grep -v _metadata.tsv | grep -v inst//curated | sort | uniq > $@